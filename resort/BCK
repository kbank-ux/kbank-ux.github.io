<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‘ê·¼ë‘ê·¼!ğŸ° íœ´ì–‘ì†Œ ì¶”ì²¨ğŸ–ï¸</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.6/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="./style.css">
</head>
<body>

    <h1 class="title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ë‘ê·¼ë‘ê·¼!ğŸ° íœ´ì–‘ì†Œ ì¶”ì²¨ğŸ–ï¸</h3>

    <h3 class="title">ğŸï¸ íœ´ì–‘ì†Œ ëª©ë¡</h3>
    <div id="resortRoomCounts">
        <!-- ê°ì‹¤ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ìƒì„± -->
        <script>
            const resorts = ['ë” ì•¤ë¦¬ì¡°íŠ¸_ë””ëŸ­ìŠ¤ íŒ¨ë°€ë¦¬íŠ¸ìœˆ', 'ë¼ë§ˆë‹¤í”„ë¼ì ì œì£¼í˜¸í…”_ìŠ¤íƒ ë‹¤ë“œ-íŒ¨ë°€ë¦¬íŠ¸ìœˆ', 'ì œì£¼ WE í˜¸í…”_ìŠˆí˜ë¦¬ì–¼ íŒ¨ë°€ë¦¬ íŠ¸ìœˆ', 'ì²´ìŠ¤í„°í†¤ìŠ¤_íˆ¬ë£¸ ìŠˆí˜ë¦¬ì–´', 'í˜¸í…” íƒ‘ìŠ¤í… ê°•ë¦‰_ì£¼ë‹ˆì–´ìŠ¤ìœ„íŠ¸'];
            const roomCounts = [2, 1, 1, 1, 2]; // ê°ì‹¤ìˆ˜ ê¸°ë³¸ê°’
            const reserveCounts = [2, 2, 2, 2, 2]; // ì˜ˆë¹„ë‹¹ì²¨ììˆ˜ ê¸°ë³¸ê°’
    
            resorts.forEach((resort, index) => {
                document.write(`
                    <div class="resort-detail">
                        <label class="resort-label">íœ´ì–‘ì†Œ${String.fromCharCode(65 + index)}</label>
                        <input type="text" class="resort-name" id="resort${String.fromCharCode(65 + index)}" size="40" value="${resort}">
                        <label class="room-label">ë°°ì • ê°€ëŠ¥ ê°ì‹¤ìˆ˜:</label>
                        <input type="text" class="room-count" id="roomCount${String.fromCharCode(65 + index)}" size="1" value="${roomCounts[index]}">
                        <label class="reserve-label">ì˜ˆë¹„ ë‹¹ì²¨ììˆ˜:</label>
                        <input type="text" class="reserve-count" id="reserveCount${String.fromCharCode(65 + index)}" size="1" value="${reserveCounts[index]}">
                    </div>
                `);
            });
        </script>
    </div>
    

    <h3>ğŸ“‡ ì§€ì›ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
    <div id="resortAapplyDdata">
        <input type="file" id="upload" accept=".xlsx"/>
        <label for="cha" style="margin-left: 175px;">ì¶”ì²¨ì°¨ìˆ˜: </label>
        <input type="text" id="cha" class="count" size="1" value="2"/>
        <button onclick="handleFile()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>


    <h3>ğŸ‰ íœ´ì–‘ì†Œë³„ ì§€ì›í˜„í™©</h3>
    <div id="tableOutput"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.8/xlsx.full.min.js"></script>
    <script>

        function getResortInputs() {
            const resorts = ['A', 'B', 'C', 'D', 'E'];
            const resortInputs = {};

            resorts.forEach(resort => {
                const resortInput = document.getElementById(`resort${resort}`);
                const roomCountInput = document.getElementById(`roomCount${resort}`);
                const reserveCountInput = document.getElementById(`reserveCount${resort}`);
                const resortName = resortInput.value;
                const roomCount = parseInt(roomCountInput.value);
                const reserveCount = parseInt(reserveCountInput.value);
                resortInputs[resortName] = { roomCount, reserveCount };
            });
            return resortInputs;
        }

        function maskName(name) {
            if (name.length > 2) {
                return name[0] + '*'.repeat(name.length - 2) + name[name.length - 1];
            } else if (name.length === 2) {
                return name[0] + '*';
            } else {
                return name;
            }
        }

        function maskPersonalInfo(jsonData) {
            const headers = jsonData[0];
            const nameIndex = headers.indexOf("ì´ë¦„");

            jsonData.slice(1).forEach(row => {
                if (nameIndex !== -1) {
                    row[nameIndex] = maskName(row[nameIndex]);
                }
            });
            return jsonData;
        }

        function groupDataByColumns(data, columns) {
            const group = {};
            const columnIndices = columns.map(column => data[0].indexOf(column));
            const chaValue = document.getElementById('cha').value;
            const chaIndex = data[0].indexOf("ì°¨ìˆ˜");

            if (columnIndices.includes(-1)) return;

            data.slice(1).forEach(row => {
                if (chaValue && String(row[chaIndex]) !== chaValue) return;  // ì°¨ìˆ˜ í•„í„°ë§

                const key = columnIndices.map(index => data[0][index] === "ë°•ìˆ˜" ? `(${row[index]}ë°•)` : row[index]).join(' ');

                group[key] = group[key] || [];
                group[key].push(row);
            });

            return group;
        }

        function renderGroupedTable(headers, data) {
            const resortInputs = getResortInputs();
            const headersToExclude = ["NO", "ì°¨ìˆ˜", "ì§€ë§", "ë¶€ì„œ", "ì ‘ìˆ˜ì¼ì‹œ", "ì—°ë½ì²˜"];

            const columnsToGroupBy = ["ìƒí’ˆëª…", "ì…ì‹¤ì¼ì", "ë°•ìˆ˜"];
            const groupedData = groupDataByColumns(data, columnsToGroupBy);

            let groupCount = 1;
            const tableOutput = document.getElementById('tableOutput');
            tableOutput.innerHTML = "";

            for (const key in groupedData) {
                const competitionRate = groupedData[key].length;
                const resortNameMatch = groupedData[key][0][3];
                const roomCount = resortInputs[resortNameMatch]?.roomCount || 0;

                const tableId = `tableGroup${groupCount}`;
                const groupHtml = `
                    <div id=tableGroupTitle${groupCount} class="group-header">
                        <div class="group-info">
                            <strong>ì¶”ì²¨ê·¸ë£¹ ${groupCount} </strong> <br><span class='group-info-title'> ${key} &nbsp;&nbsp; (ê²½ìŸë¥ : ${competitionRate}:${roomCount}) </span>
                        </div>
                        <div class="button-container">
                            <button onclick="startLottery(${groupCount}, '${resortNameMatch}', '#17008C', false)">ì¶”ì²¨í•˜ê¸°</button>
                            <button onclick="startLottery(${groupCount}, '${resortNameMatch}', '#69B405', true)" disabled>ì˜ˆë¹„ì¶”ì²¨</button>
                        </div>
                    </div>
                    <table border='1' id='${tableId}'><tr>
                        ${headers.filter(header => !headersToExclude.includes(header)).map(header => `<th>${header}</th>`).join('')}
                        
                    </tr>
                    ${groupedData[key].map(row =>
                        `<tr>${row.filter((_, index) => !headersToExclude.includes(headers[index])).map(cell => `<td>${cell || ''}</td>`).join('')}</tr>`
                    ).join('')}
                    </table><br>
                `;

                tableOutput.insertAdjacentHTML('beforeend', groupHtml);
                groupCount++;
            }

        }

        // ê° ì¶”ì²¨ê·¸ë£¹ë§ˆë‹¤ selectedRowsì™€ reservedRows ê´€ë¦¬
        let selectedRowsByGroup = {};
        let reservedRowsByGroup = {};
        let selectedEmployeeIds = [];  // ì¤‘ë³µ í™•ì¸ì„ ìœ„í•œ ë‹¹ì²¨ ì‚¬ë²ˆ ëª©ë¡

        function startLottery(groupNumber, resortNameMatch, color, isReserve) {
            disableButtons(); 
            selectedRowsByGroup[groupNumber] = selectedRowsByGroup[groupNumber] || [];
            reservedRowsByGroup[groupNumber] = reservedRowsByGroup[groupNumber] || [];
            const selectedRows = selectedRowsByGroup[groupNumber];
            const reservedRow = reservedRowsByGroup[groupNumber];

            const resortInputs = getResortInputs();
            const count = isReserve ? resortInputs[resortNameMatch]?.reserveCount || 0 : resortInputs[resortNameMatch]?.roomCount || 0;

            if (isReserve && selectedRows.length === 0) {
                alert("ì˜ˆë¹„ì¶”ì²¨ì€ ì¶”ì²¨ì´ ì™„ë£Œëœ ë’¤ì— í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            if (!isReserve && selectedRows.length >= count) {
                alert("ë°°ì •ëœ ê°ì‹¤ìˆ˜ë§Œí¼ ì¶”ì²¨ì´ ì™„ë£Œë˜ì–´ ë” ì´ìƒ ì¶”ì²¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (isReserve && reservedRow.length >= count) {
                alert("ì˜ˆë¹„ë‹¹ì²¨ì ìˆ˜ë§Œí¼ ì¶”ì²¨ì´ ì™„ë£Œë˜ì–´ ë” ì´ìƒ ì¶”ì²¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            startLotteryAnimation(groupNumber, color, count, isReserve);
        }


        function startLotteryAnimation(groupNumber, color, count, isReserve) {
            const selectedRows = selectedRowsByGroup[groupNumber] || [];
            const reservedRows = reservedRowsByGroup[groupNumber] || [];

            const table = document.querySelector(`#tableGroup${groupNumber}`);
            if (!table) return;

            const rows = Array.from(table.querySelectorAll("tr")).slice(1).filter(row => !selectedRows.includes(row) && !reservedRows.includes(row));
            if (rows.length === 0) 
                return;
            
            if (rows.length === 1) {
                const targetRow = rows[0];
                handleSelectedRow(rows,targetRow, groupNumber, color, count, isReserve, 0);
                return;
            }

            const targetPassCount = Math.floor(Math.random() * 1) + (Math.round(10/(rows.length+3))+1)*2;
            const targetRow = rows[Math.floor(Math.random() * rows.length)];
            let currentPass = 0;
            let rowIndex = 0;
            let transitionDuration = (Math.round(10/rows.length)+1)*10;
            const animateRow = () => {
            
                if (rowIndex >= rows.length) {
                    rowIndex = 0;
                    currentPass++;
                }

                const row = rows[rowIndex];
                row.style.transition = `background-color ${transitionDuration}ms, color ${transitionDuration}ms`;
                row.style.backgroundColor = color;

                setTimeout(() => {
                    row.style.backgroundColor = '';

                    if (currentPass >= targetPassCount && row === targetRow) {
                        handleSelectedRow(rows,targetRow, groupNumber, color, count, isReserve, transitionDuration);
                        return;
                    }

                    rowIndex++;
                    transitionDuration *= 1 + 0.01 * (Math.max(Math.round(10/rows.length)+1,2)) * 2;
                    animateRow();
                }, transitionDuration);
            };

            animateRow();
        }

        function handleSelectedRow(rows,targetRow, groupNumber, color, count, isReserve, transitionDuration) {
            targetRow.style.backgroundColor = color;
            targetRow.style.color = "white";
            const empIdIndex = 4;
            const selectedEmpId = targetRow.cells[empIdIndex].textContent;

            if (!isReserve) {
                selectedRowsByGroup[groupNumber].push(targetRow);
                const resultCell = targetRow.insertCell(-1);
                resultCell.textContent = 'ë‹¹ì²¨';
                if (selectedEmployeeIds.includes(selectedEmpId)) {
                    selectedEmployeeIds.filter(id => id === selectedEmpId).forEach(dupId => {
                        Array.from(document.querySelectorAll('td')).filter(td => td.textContent === dupId.toString()).forEach(td => {
                            if (td.nextSibling) {
                                td.nextSibling.textContent = "ë‹¹ì²¨(ì¤‘ë³µ)";
                            }
                        });
                    });
                }
                selectedEmployeeIds.push(selectedEmpId);
            } else {
                reservedRowsByGroup[groupNumber].push(targetRow);
                const currentReserveCount = reservedRowsByGroup[groupNumber].length;
                const resultCell = targetRow.insertCell(-1);
                resultCell.textContent = `ì˜ˆë¹„${currentReserveCount}`;
            }

            if (count - 1 > 0) {
                setTimeout(() => {
                    if (isReserve) color = adjustBrightness(color, -10);
                    if (rows.length ===1) {
                        enableButtons();  // ë²„íŠ¼ì„ ë‹¤ì‹œ í™œì„±í™”í•©ë‹ˆë‹¤.
                        const buttons = document.querySelectorAll(`#tableGroupTitle${groupNumber} button`);
                        if (buttons && buttons[1]) {
                            buttons[1].disabled = true;
                        }
                        return;
                    }
                    startLotteryAnimation(groupNumber, color, count - 1, isReserve);
                }, transitionDuration * 2);
            }
            if (count == 1) {
                enableButtons();
                if (!isReserve) {
                    const buttons = document.querySelectorAll(`#tableGroupTitle${groupNumber} button`);
                    if (buttons && buttons[0]) {
                        buttons[0].disabled = true;
                    }
                    if (buttons && buttons[1]) {
                        buttons[1].disabled = false;
                    }
                }else{
                    const buttons = document.querySelectorAll(`#tableGroupTitle${groupNumber} button`);
                    if (buttons && buttons[1]) {
                        buttons[1].disabled = true;
                    }
                }
            }
        }


        function adjustBrightness(hex, percent) {
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);

            r = Math.min(Math.max(0, r + Math.round((percent / 100) * 255)), 255);
            g = Math.min(Math.max(0, g + Math.round((percent / 100) * 255)), 255);
            b = Math.min(Math.max(0, b + Math.round((percent / 100) * 255)), 255);

            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        let initiallyDisabledButtons = []; 

        function disableButtons() {
            const buttons = document.querySelectorAll('button');
            initiallyDisabledButtons = [];
            buttons.forEach(button => {
                if (button.disabled) {
                    initiallyDisabledButtons.push(button);
                }
                button.disabled = true;
            });
        }

        function enableButtons() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (!initiallyDisabledButtons.includes(button)) {
                    button.disabled = false;
                }
            });
        }

        function handleFile() {
            const input = document.getElementById('upload');
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async event => {
                try {
                    const data = event.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const headers = jsonData[0];
                    const maskedData = maskPersonalInfo(jsonData);
                    renderGroupedTable(headers, maskedData);

                    selectedRowsByGroup = {};
                    reservedRowsByGroup = {};
                    selectedEmployeeIds = [];
                } catch (error) {
                    console.error(error);
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsBinaryString(file);
            
        }

    </script>
</body>
</html>
